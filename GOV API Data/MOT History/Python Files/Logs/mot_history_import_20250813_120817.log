2025-08-13 12:08:17,704 - MOTHistoryImport - INFO - Logging initialized. Log file: Logs\mot_history_import_20250813_120817.log
2025-08-13 12:08:17,704 - MOTHistoryImport - INFO - Configuration loaded: {'database': {'server': 'MLNOESQLUAT01', 'database': 'Engineering', 'trusted_connection': True}, 'files': {'log_directory': 'Logs'}, 'processing': {'batch_size': 100, 'request_timeout': 30, 'max_retries': 3}, 'logging': {'log_level': 'DEBUG'}, 'security': {'client_id_from_env': True, 'client_secret_from_env': True, 'api_key_from_env': True, 'db_password_from_env': False}}
2025-08-13 12:08:17,768 - MOTHistoryImport - INFO - JSON data logging initialized. File: Logs\mot_history_data_20250813_120817.json
2025-08-13 12:08:17,774 - MOTHistoryImport - INFO - Using config rate limit: 15 RPS
2025-08-13 12:08:17,774 - MOTHistoryImport - INFO - Starting Database connection to MLNOESQLUAT01.Engineering with 15-minute retry window
2025-08-13 12:08:17,774 - MOTHistoryImport - INFO - Establishing database connection...
2025-08-13 12:08:17,900 - MOTHistoryImport - INFO - Database connection established successfully
2025-08-13 12:08:17,910 - MOTHistoryImport - DEBUG - Retrieved APIId 2 for service 'GOV MOT History Service'
2025-08-13 12:08:17,910 - MOTHistoryImport - DEBUG - Retrieved rate limit 1 seconds for APIId 2
2025-08-13 12:08:17,910 - MOTHistoryImport - INFO - Updated rate limit from 15.000 to 1.000 RPS (1s interval)
2025-08-13 12:08:17,926 - MOTHistoryImport - INFO - API logging initialized - APIId: 2, Rate Limit: 1s
2025-08-13 12:08:17,926 - MOTHistoryImport - DEBUG - API logging enabled for MOTAPIClient with APIId: 2
2025-08-13 12:08:17,926 - MOTHistoryImport - INFO - Starting MOT History Data Import (Bulk Mode)
2025-08-13 12:08:17,926 - MOTHistoryImport - INFO - Starting Database connection to MLNOESQLUAT01.Engineering with 15-minute retry window
2025-08-13 12:08:17,926 - MOTHistoryImport - INFO - Establishing database connection...
2025-08-13 12:08:18,005 - MOTHistoryImport - INFO - Database connection established successfully
2025-08-13 12:08:18,005 - MOTHistoryImport - INFO - Truncating table: StageMOTVehicles
2025-08-13 12:08:18,005 - MOTHistoryImport - INFO - Successfully truncated table: StageMOTVehicles
2025-08-13 12:08:18,021 - MOTHistoryImport - INFO - Truncating table: StageMOTTests
2025-08-13 12:08:18,021 - MOTHistoryImport - INFO - Successfully truncated table: StageMOTTests
2025-08-13 12:08:18,021 - MOTHistoryImport - INFO - Truncating table: StageMOTDefects
2025-08-13 12:08:18,037 - MOTHistoryImport - INFO - Successfully truncated table: StageMOTDefects
2025-08-13 12:08:18,037 - MOTHistoryImport - INFO - Truncating table: StageMOTVehiclesNotFound
2025-08-13 12:08:18,053 - MOTHistoryImport - INFO - Successfully truncated table: StageMOTVehiclesNotFound
2025-08-13 12:08:18,053 - MOTHistoryImport - INFO - Reading vehicle registrations from source database: MLNOESQLEXP01
2025-08-13 12:08:18,053 - MOTHistoryImport - INFO - Starting Source database connection to MLNOESQLEXP01.ML-Equinox with 15-minute retry window
2025-08-13 12:08:18,053 - MOTHistoryImport - INFO - Establishing source database connection to MLNOESQLEXP01
2025-08-13 12:08:18,196 - MOTHistoryImport - INFO - Read 6 vehicle registrations from source database (MLNOESQLEXP01)
2025-08-13 12:08:18,200 - MOTHistoryImport - INFO - Added 3 test registrations: YX111FH, SK111KZ, SK111PP
2025-08-13 12:08:18,212 - MOTHistoryImport - INFO - Processing batch 1/1 (6 registrations)
2025-08-13 12:08:18,212 - MOTHistoryImport - INFO - Requesting new OAuth2 token...
2025-08-13 12:08:18,228 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): login.microsoftonline.com:443
2025-08-13 12:08:18,376 - urllib3.connectionpool - DEBUG - https://login.microsoftonline.com:443 "POST /a455b827-244f-4c97-b5b4-ce5d13b4d00c/oauth2/v2.0/token HTTP/1.1" 200 1456
2025-08-13 12:08:18,388 - MOTHistoryImport - INFO - OAuth2 token obtained successfully
2025-08-13 12:08:18,392 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): history.mot.api.gov.uk:443
2025-08-13 12:08:19,073 - urllib3.connectionpool - DEBUG - https://history.mot.api.gov.uk:443 "GET /v1/trade/vehicles/registration/SK74BKZ HTTP/1.1" 200 None
2025-08-13 12:08:19,757 - urllib3.connectionpool - DEBUG - https://history.mot.api.gov.uk:443 "GET /v1/trade/vehicles/registration/BD74WGX HTTP/1.1" 200 None
2025-08-13 12:08:20,360 - urllib3.connectionpool - DEBUG - https://history.mot.api.gov.uk:443 "GET /v1/trade/vehicles/registration/YX74OEZ HTTP/1.1" 200 None
2025-08-13 12:08:20,853 - urllib3.connectionpool - DEBUG - https://history.mot.api.gov.uk:443 "GET /v1/trade/vehicles/registration/YX111FH HTTP/1.1" 404 None
2025-08-13 12:08:20,853 - MOTHistoryImport - WARNING - Registration not found in MOT API: YX111FH
2025-08-13 12:08:21,251 - urllib3.connectionpool - DEBUG - https://history.mot.api.gov.uk:443 "GET /v1/trade/vehicles/registration/SK111KZ HTTP/1.1" 404 None
2025-08-13 12:08:21,267 - MOTHistoryImport - WARNING - Registration not found in MOT API: SK111KZ
2025-08-13 12:08:21,932 - urllib3.connectionpool - DEBUG - https://history.mot.api.gov.uk:443 "GET /v1/trade/vehicles/registration/SK111PP HTTP/1.1" 404 None
2025-08-13 12:08:21,934 - MOTHistoryImport - WARNING - Registration not found in MOT API: SK111PP
2025-08-13 12:08:22,060 - MOTHistoryImport - INFO - Bulk inserting 3 vehicle records...
2025-08-13 12:08:22,155 - MOTHistoryImport - INFO - Successfully bulk inserted 3 vehicle records
2025-08-13 12:08:22,161 - MOTHistoryImport - INFO - Bulk inserting 1 test records...
2025-08-13 12:08:22,189 - MOTHistoryImport - INFO - Successfully exported 1 records to CSV_Exports\StageMOTTests_20250813_120822.csv
2025-08-13 12:08:22,205 - MOTHistoryImport - INFO - Successfully processed 1 test records (0 duplicates skipped)
2025-08-13 12:08:22,205 - MOTHistoryImport - INFO - Bulk inserting 3 not found registrations...
2025-08-13 12:08:22,219 - MOTHistoryImport - INFO - Successfully bulk inserted 3 not found registrations
2025-08-13 12:08:22,235 - MOTHistoryImport - INFO - Bulk batch committed: 3 successful, 3 failed, 3 vehicles, 1 tests, 0 defects, 3 not found
2025-08-13 12:08:22,235 - MOTHistoryImport - INFO - Progress: 100.0% (6/6)
2025-08-13 12:08:22,235 - MOTHistoryImport - INFO - Running merge procedures after all batches...
2025-08-13 12:08:22,250 - MOTHistoryImport - INFO - Running spFactMOTVehicles_Merge...
2025-08-13 12:08:22,250 - MOTHistoryImport - INFO - spFactMOTVehicles_Merge completed successfully
2025-08-13 12:08:22,250 - MOTHistoryImport - INFO - Running spFactMOTTests_Merge...
2025-08-13 12:08:22,266 - MOTHistoryImport - INFO - spFactMOTTests_Merge completed successfully
2025-08-13 12:08:22,266 - MOTHistoryImport - INFO - Running spFactMOTDefects_Merge...
2025-08-13 12:08:22,282 - MOTHistoryImport - INFO - spFactMOTDefects_Merge completed successfully
2025-08-13 12:08:22,284 - MOTHistoryImport - INFO - Running spFactMOTVehiclesNotFound_Merge...
2025-08-13 12:08:22,305 - MOTHistoryImport - INFO - spFactMOTVehiclesNotFound_Merge completed successfully
2025-08-13 12:08:22,315 - MOTHistoryImport - INFO - All merge stored procedures completed successfully
2025-08-13 12:08:22,318 - MOTHistoryImport - INFO - ==================================================
2025-08-13 12:08:22,318 - MOTHistoryImport - INFO - MOT HISTORY DATA IMPORT COMPLETED
2025-08-13 12:08:22,318 - MOTHistoryImport - INFO - ==================================================
2025-08-13 12:08:22,330 - MOTHistoryImport - INFO - Total registrations processed: 6
2025-08-13 12:08:22,330 - MOTHistoryImport - INFO - Successful imports: 3
2025-08-13 12:08:22,330 - MOTHistoryImport - INFO - Failed imports: 3
2025-08-13 12:08:22,330 - MOTHistoryImport - INFO - Registrations not found: 3
2025-08-13 12:08:22,330 - MOTHistoryImport - INFO - Vehicles inserted: 3
2025-08-13 12:08:22,346 - MOTHistoryImport - INFO - Tests inserted: 1
2025-08-13 12:08:22,346 - MOTHistoryImport - INFO - Defects inserted: 0
2025-08-13 12:08:22,346 - MOTHistoryImport - INFO - Total duration: 0:00:04.391867
2025-08-13 12:08:22,346 - MOTHistoryImport - INFO - Average time per registration: 0:00:00.731978
2025-08-13 12:08:22,346 - MOTHistoryImport - INFO - ========================= API RATE STATS =========================
2025-08-13 12:08:22,362 - MOTHistoryImport - INFO - Total API requests: 3
2025-08-13 12:08:22,362 - MOTHistoryImport - INFO - Final RPS (60-sec window): 2.33
2025-08-13 12:08:22,362 - MOTHistoryImport - INFO - Average RPS (overall): 0.73
2025-08-13 12:08:22,362 - MOTHistoryImport - INFO - Configured rate delay: 0.0s
2025-08-13 12:08:22,362 - MOTHistoryImport - INFO - API request duration: 4.1s
2025-08-13 12:08:22,362 - MOTHistoryImport - INFO - ==================================================
2025-08-13 12:08:22,554 - MOTHistoryImport - INFO - Email sent successfully to cdunbar@metroline.co.uk
2025-08-13 12:08:22,554 - MOTHistoryImport - INFO - Success notification email sent
2025-08-13 12:08:22,572 - MOTHistoryImport - INFO - Database connection closed
